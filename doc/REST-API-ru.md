# Система

**Система** построена на базе фреймворка [Апостол](https://github.com/ufocomp/apostol). 

Система состоит из двух абстрактных частей **платформы** и **конфигурации**. 

* **Платформа** - это технологии и протоколы, встроенные службы и модули.
* **Конфигурация** - это бизнес логика конкретного проекта.

**Платформа** написана на языке программирования C++, имеет модульную конструкцию и включает в себя встроенную поддержку СУБД [PostgreSQL](https://www.postgresql.org).

[База данных](https://github.com/ufocomp/db-platform) платформы написана на языке программирования PL/pgSQL.

Платформа состоит из следующих **_модулей_** (частей):

- [Сервера авторизации](https://github.com/ufocomp/module-AppServer);
- [Сервера приложений](https://github.com/ufocomp/module-AuthServer) (REST API);
- [Веб-сервера](https://github.com/ufocomp/module-WebServer) (HTTP-сервера);
- [WebSocket API](https://github.com/ufocomp/module-WebSocketAPI).

**Конфигурация** написана на языке программирования PL/pgSQL, используется для разработки бизнес-логики и RESTful API. 

Конфигурация базируется на API платформы и дополняет её функциями необходимыми для решения задач конкретного проекта.

# Платформа

## Сервер авторизации

**Сервер авторизации** разработан на основе спецификации **OAuth 2.0** [RFC 6749](https://tools.ietf.org/html/rfc6749) и расширении **OpenID Connect**.

[Подробная документация доступна по этой ссылке.](https://github.com/ufocomp/module-AuthServer)

## Сервер приложений

**Сервер приложений** используется для удалённого вызова процедур с использованием архитектурного стиля [REST](https://ru.wikipedia.org/wiki/REST) (от англ. Representational State Transfer — _передача состояния представления_).

[Подробная документация доступна по этой ссылке.](https://github.com/ufocomp/module-AppServer)

## Веб-сервер

**Веб-сервер** (HTTP-сервер) используется для взаиможействия с системой через Веб-интерфейс.

[Подробная документация доступна по этой ссылке.](https://github.com/ufocomp/module-WebServer)

## WebSocket API

**WebSocket API** предоставляет возможность подключения и передачи запросов к API системы по протоколу [WebSocket](https://ru.wikipedia.org/wiki/WebSocket).

[Подробная документация доступна по этой ссылке.](https://github.com/ufocomp/module-WebSocketAPI)

## База данных

### Описание

### Абстракция представления данных в системе

Данные в системе представлены в виде объектов и имеют слой абстракции.

[Подробнее по этой ссылке.](https://github.com/ufocomp/db-platform)

## API

### Общие параметры запроса для списка
* Для конечных точек возвращающих данные в виде списка `/<endpoint>/list` применимо единное правило и следующее параметры:

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ | ------------
fields | JSON | Массив строк | Список полей. Если не указан, вернёт все доступные поля. 
search | JSON | Массив объектов | Условия для отбора данных. 
filter | JSON | Объект | Фильтр для отбора данных в виде пары ключ/значение. В качестве ключа указывается имя поля. `filter` является краткой формой `search`. 
reclimit | INTEGER | Число | Возвращает не больше заданного числа строк (может быть меньше, если сам запрос выдал меньшее количество строк).
recoffset | INTEGER | Число | Пропускает указанное число строк в запросе.
orderby | JSON | Массив строк | Порядок сортировки (список полей). Допустимо указание `ASC` и `DESC` (`name DESC`) 

**Расшифровка параметра `search`**:

Ключ | Тип | Обязательный | Описание
------------ | ------------ | ------------ | ------------
condition | STRING | НЕТ | Условие. Может принимать только два значения `AND` (по умолчанию) или `OR`. 
field | STRING | ДА | Наименование поля, к которому применяется условие. 
compare | STRING | НЕТ | Сравнение. Может принимать только одно из значений: (`EQL`, `NEQ`, `LSS`, `LEQ`, `GTR`, `GEQ`, `GIN`, `LKE`, `ISN`, `INN`, `AND`, `OR`, `XOR`, `NOT`).
value | STRING | ДА/НЕТ | Искомое значение. 
valarr | JSON | ДА/НЕТ | Искомые значения в виде массива. Если указан ключ `valarr`, то ключи `compare` и `value` игнорируются.

**Формат `compare`:**

Значение | Описание
------------ | ------------
EQL | Равно (по умолчанию). 
NEQ | Не равно. 
LSS | Меньше. 
LEQ | Меньше или равно. 
GTR | Больше. 
GEQ | Больше или равно. 
GIN | Для поиска вхождений JSON.
AND | Битовый AND.
OR  | Битовый OR.
XOR | Битовый XOR.
NOT | Битовый NOT.
LKE | LIKE - Значение ключа `value` должно передаваться вместе со знаком '%' в нужном месте;
ISN | Ключ `value` должен быть опушен (не указан). 
INN | Ключ `value` должен быть опушен (не указан). 

**Примеры:**

```http request
POST /api/v1/object/geolocation/list HTTP/1.1
Host: localhost:8080
Content-Type: application/json
Authorization: Basic YWRtaW46YWRtaW4=

{"filter": {"object": 2, "code": "default"}}
````

```http request
POST /api/v1/address/list HTTP/1.1
Host: localhost:8080
Content-Type: application/json
Authorization: Basic YWRtaW46YWRtaW4=

{"fields": ["description"], "search": [{"field": "apartment", "compare": "GEQ", "value": "5"}]}
````

```http request
POST /api/v1/admin/session/list HTTP/1.1
Host: localhost:8080
Content-Type: application/json
Authorization: Basic YWRtaW46YWRtaW4=

{"search": [{"field":"userid","compare":"EQL","value":"1004","condition":"OR", "lstr": "("},{"field":"userid","compare":"EQL","value":"1010","condition":"OR", "rstr": ")"},{"field":"created","compare":"LSS","value":"12.08.2020"},{"field":"created","compare":"GEQ","value":"11.08.2020"}]}
````

### Конечные точки

#### Тест подключения
```http request
GET /api/v1/ping
```
Проверить подключение к REST API.
 
**Параметры запроса:**
НЕТ
 
**Пример ответа:**
```json
{}
```
 
#### Проверить время сервера
```http request
GET /api/v1/time
```
Проверить подключение к REST API и получить текущее время сервера.
 
**Параметры запроса:**
 НЕТ
  
**Пример ответа:**
```json
{
  "serverTime": 1583495795455
}
```

### Регистрация

```http request
POST /api/v1/sign/up
```
Регистрация нового пользователя в системе.

* Для вызова метода необходимо предварительно получить разрешение на авторизацию [учётные данные клиента](#учётные-данные-клиента).

* Метод вызывается сервером авторизации при регистрации пользователя. 

**Параметры:**

Имя | Тип | Значение | Описание
------------ | ------------| ------------ |------------
type | STRING | entity, physical, individual | **Рекомендуемый**. Тип клиента. По умолчаию: physical. 
username | STRING | | **Обязательный**. Логин пользователя. 
password | STRING | | **Обязательный**. Пароль пользователя.
name | JSON object | | **Рекомендуемый**. Полное наименование компании/Ф.И.О. клиента (пользователя).
phone | STRING | | **Рекомендуемый**. Телефон.
email | STRING | | **Рекомендуемый**. Электронный адрес.
info | JSON  | | **Рекомендуемый**. Дополнительная информация.
description | STRING | | **Рекомендуемый**. Описание.

**Формат `name`:**

Ключ | Тип | Описание
------------ | ------------ | ------------
name | STRING | **Рекомендуемый**. Полное наименование организации/Ф.И.О одной строкой
short | STRING | **Рекомендуемый**. Краткое наименование организации
first | STRING | **Рекомендуемый**. Имя
last | STRING | **Рекомендуемый**. Фамилия
middle | STRING | **Рекомендуемый**. Отчество

Группы:
 - `<name>` `[<short>]`
 - `<first>` `<last>` `[<middle>]` `[<short>]`

**Формат `info`:** произвольный.

**Описание ответа:**

Поле | Тип | Описание
------------ | ------------ | ------------
id | NUMERIC | Идентификатор созданного пользователя.
userid | NUMERIC | Идентификатор учётной записи пользователя.
  
**Пример:**

Запрос:
```http request
POST /api/v1/sign/up HTTP/1.1
Host: localhost:8080
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{"type":"physical","name":{"name":"User Name","short":"User Name","first":"User","last":"Name","middle":""},"phone":"","email":"mail@mail.ru"}
```

Ответ (положительный):
```json
{"id":2,"userid":1009}
``` 
 
Ответ (отрицательный):
```json
{"error": {"code": 400, "message": "Учётная запись с электронным адресом \"mail@mail.ru\" уже зарегистрирована."}}
``` 
 
### Вход в систему

```http request
POST /api/v1/sign/in
```
Вход в систему по предоставленным данным от пользователя.

* Обратите внимание, что наличие маркера доступа (пользователя) свидетельствует о том, что вход в систему уже был осуществлён.    

* Метод вызывается сервером авторизации при входе в систему. Вызов метода на прямую приведет к ошибке. 

* Для входа в систему используйте конечные точки сервера авторизации: [Учётные данные владельца ресурса](https://github.com/ufocomp/module-AuthServer#%D1%83%D1%87%D1%91%D1%82%D0%BD%D1%8B%D0%B5-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D0%B5-%D0%B2%D0%BB%D0%B0%D0%B4%D0%B5%D0%BB%D1%8C%D1%86%D0%B0-%D1%80%D0%B5%D1%81%D1%83%D1%80%D1%81%D0%B0).

**Параметры:**

Поле | Тип | Описание
------------ | ------------ | ------------
username | STRING | **Вариативный**. Имя пользователя (Персональный код).
phone | STRING | **Вариативный**. Телефон.
email | STRING | **Вариативный**. Электронный адрес.
password | STRING | **Вариативный**. Пароль. Если `username` это персональный код, то  в `password` нужно передать хеш SHA1(`secret`) от секретного кода пользователя.
agent | STRING | **Игнорируется**. Агент пользователя (браузер). Значение проставляется системой.
host | STRING | **Игнорируется**. IP адрес. Значение проставляется системой.
  
**Варианты:**
 - `<username>` `<password>`
 - `<phone>` `<password>`
 - `<email>` `<password>`
  
**Описание ответа:**

Поле | Тип | Описание
------------ | ------------ | ------------
session | STRING | Код сессии.
code | STRING | Код авторизации для получения маркера доступа по протоколу OAuth 2.0.
secret | STRING | Секретный ключ (не путать с секретныйм кодом пользователя) для подписи методом HMAC-SHA256.
  
**Пример:**

Запрос:
```http request
POST /api/v1/sign/in HTTP/1.1
Host: localhost:8080
Content-Type: application/json

{"username": "user", "password": "user"}
```

Ответ (положительный):
```json
{
  "session":"149d2ae6fa3f82eda21f7dba21824f199d508343",
  "code":"0s4mI+o6tKbubsOirzgxl24/SVoWI8L3ruJYUz/J0+SjbnW12oF9kVe1B642Uw8P",
  "secret":"pkPm5zmHKj04Xr/NH1nKr6ZEUqOfyacC79HLFIQTrBgA6ApbgBvGiJlMBy4XBApt"
}
```

Ответ (отрицательный):
```json
{"error": {"code": 401, "message": "Вход в систему невозможен. Проверьте правильность имени пользователя и повторите ввод пароля."}}
```

#### Выход из системы

```http request
POST /api/v1/sign/out
```
Выйти из системы и закрыть сессию.

**Параметры запроса:**

Поле | Тип | Описание
------------ | ------------ | ------------
session | STRING | **Обязательный**. Сессия.
close_all | BOOLEAN | **Необязательный**. Закрыть все сессии.

#### Аутентификация

```http request
POST /api/v1/authenticate
```
Аутентифицировать пользователя по коду сессии и секретному коду (сессии).

**Параметры запроса:**

Поле | Тип | Описание
------------ | ------------ | ------------
session | STRING | **Обязательный**. Сессия.
secret | STRING | **Обязательный**. Секретный код.
agent | STRING | **Необязательный**. Агент.
host | STRING | **Необязательный**. IP адрес.

**Описание ответа:**

Поле | Тип | Описание
------------ | ------------ | ------------
code | STRING | Код авторизации для получения маркера доступа.

#### Авторизация

```http request
POST /api/v1/authorize
```
Авторизовать пользователя по коду сессии.

**Параметры запроса:**

Поле | Тип | Описание
------------ | ------------ | ------------
session | STRING | **Обязательный**. Сессия.

**Описание ответа:**

Поле | Тип | Описание
------------ | ------------ | ------------
authorized | BOOLEAN | Результат авторизации.
message | STRING | Сообщение.

#### Кто я?
```http request
POST /api/v1/whoami
```
Информация об авторизованном пользователе.

**Параметры запроса:**
 НЕТ

**Описание ответа:**

Поле | Тип | Описание
------------ | ------------ | ------------
id | NUMERIC | Идентификатор клиента. Может быть null если учётная запись пользователя не связана с клиентом (например вход произведён от имени администратора системы).
userid | NUMERIC | Идентификатор учётной записи пользователя.
suid | NUMERIC | Идентификатор учётной записи системного пользователя.
admin | BOOLEAN | Признак прав доступа на уровне администратора системы.
profile | JSON | Профиль пользователя (учётной записи).
name | JSON | Наименование клиента.
email | JSON | Справочник электронных адресов клиента.
phone | JSON | Телефонный справочник клиента.
session | JSON | Сессия.
locale | JSON | Локаль.
area | JSON | Зона.
interface | JSON | Интерфейс.

**Описание `profile`:**

Поле | Тип | Описание
------------ | ------------ | ------------
id | NUMERIC | Идентификатор учётной записи.
username | STRING | Логин.
name | STRING | Полное наименование.
family_name | STRING | Фамилия.
given_name | STRING | Имя.
patronymic_name | STRING | Отчество.
email | STRING | Электронный адрес для входа в систему.
email_verified | BOOLEAN | Электронный адрес подтверждён.
phone | STRING | Телефон для входа в систему.
phone_verified | BOOLEAN | Телефон подтверждён.
session_limit | INTEGER | Максимально допустимое количество одновременно открытых сессий.
created | TIMESTAMP | Создан.
locale | STRING | Код локали по умолчанию.
area | STRING | Код зоны (подразделения) по умолчанию.
interface | STRING | Код интерфейса (рабочего места) по умолчанию.
description | STRING | Описание пользователя.
picture | STRING | URL на логотип.
passwordchange | BOOLEAN | Сменить пароль при следующем входе в систему (да/нет).
passwordnotchange | BOOLEAN | Установлен запрет на смену пароля самим пользователем (да/нет).
system | BOOLEAN | Системный пользователь (пользователь СУБД).
status | STRING | Статус пользователя.
state | STRING | Состояние пользователя.
lock_date | TIMESTAMP | Дата блокировки пользователя.
expiry_date | TIMESTAMP | Дата окончания срока действия пароля.
lc_ip | STRING | IP адрес последнего подключения.
input_count | NUMERIC | Счетчик входов.
input_last | TIMESTAMP | Последний вход.
input_error | NUMERIC | Текущие неудавшиеся входы.
input_error_last | TIMESTAMP | Последний неудавшийся вход в систему.
input_error_all | NUMERIC | Общее количество неудачных входов.
  
<details>
  <summary>Пример ответа</summary>

```json
{
  "id": 14,
  "userid": 1012,
  "suid": 1012,
  "admin": false,
  "profile": {
    "id": 1012,
    "username": "user",
    "name": "Пользователь",
    "given_name": null,
    "family_name": null,
    "patronymic_name": null,
    "email": null,
    "email_verified": false,
    "phone": null,
    "phone_verified": false,
    "session_limit": 0,
    "created": "2020-08-05T21:14:18.446581",
    "locale": "ru",
    "area": "default",
    "interface": "I:1:0:0",
    "description": "Пользователь",
    "picture": null,
    "passwordchange": true,
    "passwordnotchange": false,
    "system": "no",
    "status": "active",
    "state": "offline",
    "lock_date": null,
    "expiry_date": null,
    "lc_ip": "127.0.0.1",
    "input_count": 8,
    "input_last": "2020-08-07T15:16:11.939721",
    "input_error": 0,
    "input_error_last": null,
    "input_error_all": 0
  },
  "name": {
    "name": "Пользователь",
    "short": null,
    "first": null,
    "last": null,
    "middle": null
  },
  "email": null,
  "phone": null,
  "session": {
    "code": "4a9adbb079b49aeb7269bbc69c845914cc12127c",
    "created": "2020-08-07T15:16:11.939721",
    "updated": "2020-08-07T15:16:17.028765",
    "agent": "Mozilla/5.0 (X11;Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) advanced-rest-client/14.0.1 Chrome/76.0.3809.146 Electron/6.1.1 Safari/537.36",
    "host": "127.0.0.1"
  },
  "locale": {
    "id": 100000000000,
    "code": "ru",
    "name": "Русский",
    "description": "Русский язык"
  },
  "area": {
    "id": 100000000012,
    "parent": 100000000011,
    "type": 100000000003,
    "code": "default",
    "name": "По умолчанию",
    "description": null,
    "validfromdate": "2020-08-05T20:49:17.092729",
    "validtodate": null
  },
  "interface": {
    "id": 100000000007,
    "sid": "I:1:0:0",
    "name": "Все",
    "description": "Интерфейс для всех"
  }
}
```
</details>

### Локализация

#### Список локализаций
```http request
POST /api/v1/locale
```
Получить список доступных локализаций.

**Параметры запроса:**
 НЕТ
  
#### Текущая локализация
```http request
POST /api/v1/current/locale
```
Получить идентификатор выбранного (текущего) языка.

**Параметры запроса:**
 НЕТ
  
#### Установить локаль
```http request
POST /api/v1/locale/set
```
Установить локаль. 

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
id | NUMERIC |  | Идентификатор
code | STRING | en, ru | Код

Группы:
 - `<id>`
 - `<code>`

#### Сущности
```http request
POST /api/v1/essence
```
Получить список сущностей.

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
fields | JSON array |  | **Необязательный**. Массив JSON string полей в таблице, если не указано то запрос вернет все поля.

#### Классы
```http request
POST /api/v1/class
```
Получить список (дерево) классов объекта.

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
fields | JSON array |  | **Необязательный**. Массив JSON string полей в таблице, если не указано то запрос вернет все поля.

#### Действия
```http request
POST /api/v1/action
```
Получить список действий.

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
fields | JSON array |  | **Необязательный**. Массив JSON string полей в таблице, если не указано то запрос вернет все поля.

#### Выполнить действие
```http request
POST /api/v1/action/run
```
Выполняет действие над объектом.

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
id | NUMERIC |  | **Обязательный**. Идентификатор объекта.
action | NUMERIC |  | **Обязательный**. Идентификатор действия.
form | JSON |  | **Необязательный**. Параметры HTML формы в формате JSON.

#### Типы состояний
```http request
POST /api/v1/state/type
```
Получить список типов состояний объекта.

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
fields | JSON array |  | **Необязательный**. Массив JSON string полей в таблице, если не указано то запрос вернет все поля.

#### Состояния
```http request
POST /api/v1/state
```
Получить список состояний объекта.

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
fields | JSON array |  | **Необязательный**. Массив JSON string полей в таблице, если не указано то запрос вернет все поля.

#### Типы объекта
```http request
POST /api/v1/type
```
Получить список типов объекта.

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
fields | JSON array |  | **Необязательный**. Массив JSON string полей в таблице, если не указано то запрос вернет все поля.

#### Метод

##### Выполнить
```http request
POST /api/v1/method/run
```
Выполняет динамический метод объекта.

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
id | NUMERIC |  | **Обязательный**. Идентификатор объекта.
method | NUMERIC |  | **Обязательный**. Идентификатор метода.
form | JSON |  | **Необязательный**. Параметры HTML формы в формате JSON.

##### Получить

```http request
POST /api/v1/method/get
```
Запросить информацию о методе документооборота.

**Обязателен** как минимум один из параметров указанный в теле запроса:

Имя | Тип | Описание
------------ | ------------ | ------------
object | NUMERIC | Идентификатор объекта
class | NUMERIC | Идентификатор класса
state | NUMERIC | Идентификатор состояния
classcode | STRING | Код класса (вместо идентификатора)
statecode | STRING | Код состояния (вместо идентификатора)

**Пример:**

Запрос:
```http request
POST /api/v1/method/get HTTP/1.1
Host: localhost:8080
Content-Type: application/x-www-form-urlencoded
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

classcode=client&statecode=enabled
```

Ответ:
```json
[
  {"id":100000000211,"parent":null,"action":100000000053,"actioncode":"disable","label":"Закрыть","visible":true},
  {"id":100000000212,"parent":null,"action":100000000054,"actioncode":"delete","label":"Удалить","visible":true}
]
```

##### Список

```http request
POST /api/v1/method/list
```
Предоставит список всех доступных методов. 

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
fields | JSON array |  | **Необязательный**. Массив JSON string полей в таблице, если не указано то запрос вернет все поля.

#### Журнал событий
```http request
POST /api/v1/event/log
```
Выводит журнал событий.

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
type | CHAR | M, W, E | **Необязательный**. Тип события.
code | INTEGER |  | **Необязательный**. Код.
datefrom | TIMESTAMP |  | **Необязательный**. Дата начала периода.
dateto | TIMESTAMP |  | **Необязательный**. Дата окончания периода.

##### Установить
```http request
POST /api/v1/event/log/set
```
Добавляет запись в журнал событий.

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
type | CHAR | M, W, E | **Необязательный**. Тип события.
code | INTEGER |  | **Необязательный**. Код.
text | STRING |  | **Необязательный**. Текст.

##### Получить
```http request
POST /api/v1/event/log/get
```
Возвращает запись в журнале событий.

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
id | NUMERIC |  | **Обязательный**. Идентификатор записи.
fields | JSON array |  | **Необязательный**. Массив JSON string полей в таблице, если не указано то запрос вернет все поля.

##### Список
```http request
POST /api/v1/event/log/list
```
Возвращает записи из журнала событий. 

**Параметры запроса:**
[Общие параметры запроса для списка](#общие-параметры-запроса-для-списка)

#### Текущие значения
```http request
POST /api/v1/current/<param>
```
Получить информацию о текущих значениях.

Где `<param>`:

- `session` (сессия);
- `user` (пользователь);
- `userid` (идентификатор пользователя);
- `username` (login пользователя);
- `area` (зона);
- `interface` (интерфейс);
- `locale` (язык);
- `oper_date` (дата операционного дня).
 
**Параметры запроса:**
 НЕТ
  
#### Сессия
```http request
POST /api/v1/session/set/<param>
```
Установить параметры текущей сессии.

Где `<param>`:

- `area` (зона);
- `interface` (интерфейс);
- `locale` (язык);
- `oper_date` (дата операционного дня).

**Параметры для (`area`, `interface`, `locale`):**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
id | NUMERIC |  | **Обязательный**. Идентификатор. Имеет приоритет над кодом.
code | STRING |  | **Обязательный**. Код.

**Параметры для (`oper_date`):**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
oper_date | TIMESTAMP |  | **Обязательный**. Переведёт систему в режим работы с архивной датой. Значение null вернет систему в нормальный режим.
 
**Параметры запроса:**
 НЕТ

#### Объект

##### Класс объекта
```http request
POST /api/v1/object/class
```
Возвращает класс объекта.

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
id | NUMERIC |  | **Обязательный**. Идентификатор объекта.

##### Тип объекта
```http request
POST /api/v1/object/type
```
Возвращает тип объекта.

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
id | NUMERIC |  | **Обязательный**. Идентификатор объекта.
fields | JSON array |  | **Необязательный**. Массив JSON string полей в таблице, если не указано то запрос вернет все поля.

##### Состояние объекта
```http request
POST /api/v1/object/state
```
Возвращает состояние объекта.

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
id | NUMERIC |  | **Обязательный**. Идентификатор объекта.
fields | JSON array |  | **Необязательный**. Массив JSON string полей в таблице, если не указано то запрос вернет все поля.

##### Удалить объект
```http request
POST /api/v1/object/force/delete
```
Принудительно "удаляет" документ (минуя события документооборота).

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
id | NUMERIC |  | **Обязательный**. Идентификатор объекта.

#### Файлы объекта
```http request
POST /api/v1/object/file
```
Получить или установить связь объекта с файлом на сервере или содержимое файла. 

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
id | NUMERIC |  | **Обязательный**. Идентификатор объекта.
files | JSON array | null OR json | **Вариативный**. Массив JSON объектов с описанием файлов.

**Формат `files`:**

Ключ | Тип | Описание
------------ | ------------ | ------------
name | STRING | **Обязательный**. Наименование файла на сервере (включая путь).
path | STRING | **Необязательный**. Только путь к файлу (на сервере).
size | INTEGER | **Необязательный**. Размер файла (осторожнее с null или 0).
date | TIMESTAMP | **Необязательный**. Дата и время файла.
data | STRING | **Необязательный**. Содержимое файла (если нужно) в формате BASE64.
hash | STRING | **Необязательный**. Хеш файла.

**ВНИМАНИЕ**: Если значение `files` не указано или равно `null`, то метод работает как `Получить` иначе как `Установить`.

##### Установить
```http request
POST /api/v1/object/files/set
```
Установить связь объекта с файлом на сервере. 

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
id | NUMERIC |  | **Обязательный**. Идентификатор объекта.
files | JSON array | | **Обязательный**. Массив JSON объектов с описанием файлов.
  
**ВНИМАНИЕ**: Значения не указанных ключей считаются как `null`.

**ВНИМАНИЕ**: Если значение ключа `size` не указано или равно нулю, то действие считается как `Удалить`.   

##### Получить
```http request
POST /api/v1/object/files/get
```
Получить связь объекта с файлом на сервере. 

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
id | NUMERIC |  | **Обязательный**. Идентификатор объекта.
name | STRING |  | **Обязательный**. Наименование файла на сервере (включая путь).
fields | JSON array |  | **Необязательный**. Массив JSON string полей в таблице, если не указано то запрос вернет все поля.

##### Список
```http request
POST /api/v1/object/files/list
```
Получить связи объекта с файлами на сервере в виде списка. 

**Параметры запроса:**
[Общие параметры запроса для списка](#общие-параметры-запроса-для-списка)

#### Данные объекта
```http request
POST /api/v1/object/data
```
Получить или установить произвольные данные для объекта. 

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
id | NUMERIC |  | **Обязательный**. Идентификатор объекта.
data | JSON array | null OR json | **Вариативный**. Массив JSON объектов с произвольными данными.

**Формат `data`:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
type | STRING | text, json, xml | **Обязательный**. Код типа произвольных данных объекта. 
code | STRING | | **Обязательный**. Код произвольных данных.
data | STRING | | **Вариативный**. Произвольные данные.

**ВНИМАНИЕ**: Если значение `data` не указано или равно `null`, то метод работает как `Получить` иначе как `Установить`.

##### Установить
```http request
POST /api/v1/object/data/set
```
Установить произвольные данные для объекта. 

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
id | NUMERIC |  | **Обязательный**. Идентификатор объекта.
data | JSON array |  | **Обязательный**. Массив JSON объектов с произвольными данными.
  
**ВНИМАНИЕ**: Значения не указанных ключей считаются как `null`.

**ВНИМАНИЕ**: Если значение ключа `data` не указано или равно `null`, то действие считается как `Удалить`.   

##### Получить
```http request
POST /api/v1/object/data/get
```
Получить произвольные данные для объекта. 

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
id | NUMERIC |  | **Обязательный**. Идентификатор объекта.
type | NUMERIC |  | **Вариативный**. Идентификатор типа произвольных данных объекта. 
typecode | STRING | text, json, xml | **Вариативный**. Код типа произвольных данных объекта. 
code | STRING | | **Обязательный**. Код произвольных данных.
fields | JSON array |  | **Необязательный**. Массив JSON string полей в таблице, если не указано то запрос вернет все поля.

##### Список
```http request
POST /api/v1/object/data/list
```
Получить произвольные данные для объекта в виде списка. 

**Параметры запроса:**
[Общие параметры запроса для списка](#общие-параметры-запроса-для-списка)

#### Геолокация объекта
```http request
POST /api/v1/object/geolocation
```
Получить или установить координаты геолокации для объекта. 

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
id | NUMERIC |  | **Обязательный**. Идентификатор объекта.
coordinates | JSON array | null OR json | **Вариативный**. Массив JSON объектов с координатами.

**Формат `coordinates`:**

Ключ | Тип | Описание
------------ | ------------ | ------------
code | STRING | **Необязательный**. Код.
latitude | NUMERIC | **Обязательный**. Широта.
longitude | NUMERIC | **Обязательный**. Долгота.
accuracy | NUMERIC | **Необязательный**. Точность (высота над уровнем моря).
label | STRING | **Необязательный**. Метка.
description | STRING | **Необязательный**. Описание.

**ВНИМАНИЕ**: Если значение `coordinates` не указано или равно `null`, то метод работает как `Получить` иначе как `Установить`.

##### Установить
```http request
POST /api/v1/object/geolocation/set
```
Установить координаты геолокации для объекта. 

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
id | NUMERIC |  | **Обязательный**. Идентификатор объекта.
coordinates | JSON array |  | **Обязательный**. Массив JSON объектов с координатами.
  
**ВНИМАНИЕ**: Координаты геолокации для объекта хранятся в виде истории по дате и времени добавления.   

##### Получить
```http request
POST /api/v1/object/geolocation/get
```
Получить последние координаты геолокации для объекта. 

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
id | NUMERIC |  | **Обязательный**. Идентификатор объекта.
fields | JSON array |  | **Необязательный**. Массив JSON string полей в таблице, если не указано то запрос вернет все поля.

**ВНИМАНИЕ**: На период может повлиять значение `oper_date` (дата операционного дня) см. [Текущие значения](#текущие-значения).   

##### Список
```http request
POST /api/v1/object/geolocation/list
```
Получить координаты геолокации в виде списка. 

**Параметры запроса:**
[Общие параметры запроса для списка](#общие-параметры-запроса-для-списка)

#### Адрес объекта
```http request
POST /api/v1/object/address
```
Получить или установить почтовый адрес объекта. 

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
id | NUMERIC |  | **Обязательный**. Идентификатор объекта.
addresses | JSON array | null OR json | **Вариативный**. Массив JSON объектов с адресами.

**Формат `addresses`:**

Ключ | Тип | Описание
------------ | ------------ | ------------
id | NUMERIC | **Вариативный**. Идентификатор адреса.
parent | NUMERIC | **Необязательный**. Идентификатор родителя.
type | STRING | **Необязательный**. Код типа адреса.
code | STRING | **Обязательный** если иные ключи не указаны. Код: ФФ СС РРР ГГГ ППП УУУУ. Где: ФФ - код страны; СС - код субъекта РФ; РРР - код района; ГГГ - код города; ППП - код населенного пункта; УУУУ - код улицы.
index | STRING | **Необязательный**. Почтовый индекс.
country | STRING | **Необязательный**. Страна.
region | STRING | **Необязательный**. Регион.
district | STRING | **Необязательный**. Район.
city | STRING | **Необязательный**. Город.
settlement | STRING | **Необязательный**. Населённый пункт.
street | STRING | **Необязательный**. Улица.
house | STRING | **Необязательный**. Дом.
building | STRING | **Необязательный**. Корпус.
structure | STRING | **Необязательный**. Строение.
apartment | STRING | **Необязательный**. Квартира.
address | STRING | **Необязательный**. Полный адрес.

**ВНИМАНИЕ**: Если значение `id` не указано или равно `null`, то будет создан новый почтовый адрес, иначе изменён.   

**ВНИМАНИЕ**: Если значение `addresses` не указано или равно `null`, то метод работает как `Получить` иначе как `Установить`.

##### Установить
```http request
POST /api/v1/object/address/set
```
Связывает ранее созданный почтовый адрес с объектом. 

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
id | NUMERIC |  | **Обязательный**. Идентификатор объекта.
address | JSON array |  | **Обязательный**. Идентификатор адреса.  
datefrom | TIMESTAMP |  | **Необязательный**. Дата начала периода.

##### Получить
```http request
POST /api/v1/object/address/get
```
Получить почтовый адрес объекта. 

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
id | NUMERIC |  | **Обязательный**. Идентификатор объекта.
fields | JSON array |  | **Необязательный**. Массив JSON string полей в таблице, если не указано то запрос вернет все поля.

##### Список
```http request
POST /api/v1/object/address/list
```
Получить координаты геолокации в виде списка. 

**Параметры запроса:**
[Общие параметры запроса для списка](#общие-параметры-запроса-для-списка)

#### КЛАДР

* Классификатор адресов Российской Федерации (КЛАДР) — ведомственный классификатор ФНС России, созданный для распределения территорий между налоговыми инспекциями и автоматизированной рассылки корреспонденции.

В систему, для удобства создания почтовых адресов (сущность `address`), интегрирован справочник КЛАДР. Реализован он в виде дерева адресов. Глубина реализации: до улиц. 

##### Получить
```http request
POST /api/v1/address/tree/get
```
Возвращает адрес из справочника адресов КЛАДР.

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
id | NUMERIC |  | **Обязательный**. Идентификатор справочника.
fields | JSON array |  | **Необязательный**. Массив JSON string полей в таблице, если не указано то запрос вернет все поля.
 
##### Список
```http request
POST /api/v1/address/tree/list
```
Возвращает справачник адресов КЛАДР в виде списка. 

**Параметры запроса:**
[Общие параметры запроса для списка](#общие-параметры-запроса-для-списка)

##### История
```http request
POST /api/v1/address/tree/history
```
Возвращает историю из справочника адресов КЛАДР.

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
id | NUMERIC |  | **Вариативный**. Идентификатор справочника. Имеет приоритет над `code`.
code | STRING |  | **Вариативный**. Код из справочника адресов: ФФ СС РРР ГГГ ППП УУУУ.

**Описание `code`:**

|  ФФ   |   СС   |   РРР   |   ГГГ   |    ППП   |    УУУУ   | 
| :---: | :----: | :-----: | :-----: | :------: |  :------: |
| Код страны | Код субъекта РФ | Код района | Код города | Код населенного пункта | Код улицы |

##### Строка
```http request
POST /api/v1/address/tree/string
```
Возвращает адрес из справочника адресов КЛАДР в виде строки.

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
code | STRING |  | **Обязательный**. Код из справочника адресов: ФФ СС РРР ГГГ ППП УУУУ.
short | INTEGER |  | **Необязательный**. Сокращение: 0 - нет; 1 - слева; 2 - справа.
level | INTEGER |  | **Необязательный**. Ограничение уровня вложенности.

## Конфигурация

**Подробное описание конфигурации смотрите в репозитории Вашего проекта**:

- [ShipSafety](https://github.com/ufocomp/apostol-sss/blob/master/doc/REST-API-ru.md)
- [Plugme](https://github.com/ufocomp/apostol-plugme/blob/master/doc/REST-API-ru.md)
- [Fenomy](https://github.com/ufocomp/apostol-fenomy/blob/master/doc/REST-API-ru.md)

### Конечные точки

#### Общие конечные точки

* Для всех _объектов_ имеются общие конечные точки:

###### Описание конечных точек сущностей [здесь](#конечные-точки-сущностей).  

```http request
POST /api/v1/<essence>/<action>
```

Где `<essence>` - это не абстрактная сущность смотрим на [дерево классов объекта](#дерево-классов-объекта) или выполняем [запрос](#сущности).

Где `<action>` (действие):
- `type` (тип);
- `method` (метод);
- `count` (количество);
- `set` (установить - добавить или изменить);
- `get` (получить);
- `list` (список);

##### Действие тип
```http request
POST /api/v1/<essence>/type
```
Информация о типе объекта.

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
fields | JSON array |  | **Необязательный**. Массив JSON string полей в таблице, если не указано то запрос вернет все поля.

##### Действие метод
```http request
POST /api/v1/<essence>/method
```
Информация о методах объекта.

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
id | NUMERIC |  | **Обязательный**. Идентификатор объекта.

##### Действие количество
```http request
POST /api/v1/<essence>/count
```
Количество объектов с возможностью указания фильтра отбора данных.

**Параметры запроса:**
[Общие параметры запроса для списка](#общие-параметры-запроса-для-списка)

##### Действие установить
```http request
POST /api/v1/<essence>/set
```
Установить данные объекта.

[Параметры](#параметры-запросов)

**ВНИМАНИЕ**: Если значение ключа `id` не указано или равно `null`, то действие считается как _добавить_, иначе как _изменить_.   

**ВНИМАНИЕ**: Значения не указанных ключей считаются как `null`.

**ВНИМАНИЕ**: Для действия _изменить_ не нужно передавать значения всех ключей, достаточно передать только те, которые требуется поменять.   

**ВНИМАНИЕ**: Ответом на запрос будут данные действия [_получить_](#действие-получить).   

##### Действие получить
```http request
POST /api/v1/<essence>/get
```
Получить данные объекта.

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
id | NUMERIC |  | **Обязательный**. Идентификатор объекта.
fields | JSON array |  | **Необязательный**. Массив JSON string полей в таблице, если не указано то запрос вернет все поля.

**ВНИМАНИЕ**: Формат данных в ответе уникален для каждой сущности и подробно описан в разделе [класс-таблицы](#класс-таблицы).    

##### Действие список
```http request
POST /api/v1/<essence>/list
```
Получить данные объекта в виде списка с возможностью указания фильтра отбора.

**Параметры запроса:**
[Общие параметры запроса для списка](#общие-параметры-запроса-для-списка)

### Конечные точки сущностей

#### Адрес (`address`)

#### Общие
```http request
POST /api/v1/address/[ type | method | count | set | get | list ]
```
[Общие конечные точки](#общие-конечные-точки)

##### Адрес в виде строки
```http request
POST /api/v1/address/get/string
```
Возвращает адрес в виде строки.

**Параметры запроса:**

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
id | NUMERIC |  | **Обязательный**. Идентификатор объекта.

#### Клиент (`client`)

#### Общие
```http request
POST /api/v1/client/[ type | method | count | set | get | list ]
```
[Общие конечные точки](#общие-конечные-точки)

### Параметры запросов

* Параметры запросов для действие [_установить_](#действие-установить).

#### Клиент (`client`)

Имя | Тип | Значение | Описание
------------ | ------------ | ------------ |------------
id | NUMERIC |  | **Обязательный** для действия _изменить_. Идентификатор объекта.
parent | NUMERIC |  | **Необязательный**. Идентификатор объекта родителя.
type | STRING |  | **Необязательный**. Код типа.
code | STRING |  | **Рекомендуемый**. ИНН - для юридического лица или имя пользователя (login).
userid | NUMERIC |  | **Необязательный**. Идентификатор учётной записи клиента. Если указать 0, то учётная запись будет создана автоматически.
name | JSON |  | **Рекомендуемый**. Наименование компании/Ф.И.О.
phone | JSON |  | **Необязательный**. Справочник телефонов.
email | JSON |  | **Необязательный**. Электронные адреса.
info | JSON |  | **Необязательный**. Дополнительная информация.
description | STRING |  | **Необязательный**. Описание.

**Формат `name`:**

Ключ | Тип | Описание
------------ | ------------ | ------------
name | STRING | **Рекомендуемый**. Полное наименование организации/Ф.И.О одной строкой
short | STRING | **Рекомендуемый**. Краткое наименование организации
first | STRING | **Рекомендуемый**. Имя
last | STRING | **Рекомендуемый**. Фамилия
middle | STRING | **Рекомендуемый**. Отчество

**Формат `phone`:** произвольный.
**Формат `email`:** произвольный.
**Формат `info`:** произвольный.

### Данные объекта
* Данные объекта хранятся в _класс-таблицах_. Конечный набор данных для каждого объекта формируется путём добавления друг к другу всех полей из всех _класс-таблиц_.

Какие именно _класс-таблицы_ участвуют в формировании набора данных можно посмотреть в [дереве классов объекта](#дерево-классов-объекта).

### Класс таблицы

#### Объект (`object`)

Поле | Тип | Описание
------------ | ------------ | ------------
id | NUMERIC | Идентификатор объекта.
parent | NUMERIC | Идентификатор родителя объекта.
essence | NUMERIC | Идентификатор сущности.
essencecode | STRING | Код сущности.
class | NUMERIC | Идентификатор класса.
classcode | STRING | Код класса.
classlabel | STRING | Метка класса.
type | NUMERIC | Идентификатор типа.
typecode | STRING | Код типа.
typename | STRING | Наименование типа.
typedescription | STRING | Описание типа.
label | STRING | Метка.
statetype | NUMERIC | Тип состояния.
statetypecode | STRING | Код типа состояния.
statetypename | STRING | Наименование типа состояния.
state | NUMERIC | Состояние.
statecode | STRING | Код состояния.
statelabel | STRING | Метка состояния.
lastupdate | TIMESTAMP | Дата последнего изменения.
owner | NUMERIC | Идентификатор учётной записи владельца.
ownercode | STRING | Код (логин) учётной записи владельца.
ownername | STRING | Наименование учётной записи владельца.
created | TIMESTAMP | Физическая дата (дата создания).
oper | NUMERIC | Идентификатор учётной записи оператора.
opercode | STRING | Код (логин) учётной записи оператора.
opername | STRING | Наименование учётной записи оператора.
operdate | TIMESTAMP | Логическая дата (дата операции).

#### Документ (`document`)

Поле | Тип | Описание
------------ | ------------ | ------------
area | NUMERIC | Идентификатор зоны видимости объекта.
areacode | STRING | Код зоны видимости объекта.
areaname | STRING | Наименование зоны видимости объекта.
description | STRING | Описание.

#### Справочник (`reference`)

Поле | Тип | Описание
------------ | ------------ | ------------
code | STRING | Код.
name | STRING | Наименование.
description | STRING | Описание.

#### Адрес (`address`)

Поле | Тип | Описание
------------ | ------------ | ------------
code | STRING | Код КЛАДР (ФФ СС РРР ГГГ ППП УУУУ). 
index | STRING | Почтовый индекс.
country | STRING | Страна.
region | STRING | Регион.
district | STRING | Район.
city | STRING | Город.
settlement | STRING | Населённый пункт.
street | STRING | Улица.
house | STRING | Дом.
building | STRING | Корпус.
structure | STRING | Строение.
apartment | STRING | Квартира.
address | STRING | Полный адрес.

**Описание `code`:**

|  ФФ   |   СС   |   РРР   |   ГГГ   |    ППП   |    УУУУ   | 
| :---: | :----: | :-----: | :-----: | :------: |  :------: |
| Код страны | Код субъекта РФ | Код района | Код города | Код населенного пункта | Код улицы |

#### Клиент (`client`)

Поле | Тип | Описание
------------ | ------------ | ------------
code | STRING | Код клиента.
userId | NUMERIC | Идентификатор учётной записи клиента.
fullname | STRING | Полное наименование компании/Ф.И.О..
shortname | STRING | Краткое наименование компании.
lastname | STRING | Фамилия.
firstname | STRING | Имя.
middlename | STRING | Отчество.
birthday | TIMESTAMP | День рождения.
phone | JSON | Справочник телефонов.
email | JSON | Электронные адреса.
info | JSON | Дополнительная информация.
locale | NUMERIC | Идентификатор локали.
localecode | STRING | Код локали.
localename | STRING | Наименование локали.
